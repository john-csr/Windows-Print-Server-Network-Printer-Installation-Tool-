<html>
<head>
  <title>Windows Print Server Network Printer Installation Tool</title>
  <meta name="author" content="John C.">
  <HTA:APPLICATION 
    ID="PrinterTool"
    APPLICATIONNAME="PrinterTool"
    BORDER="thin"
    BORDERSTYLE="normal"
    CAPTION="yes"
    SHOWINTASKBAR="yes"
    SINGLEINSTANCE="yes"
    WINDOWSTATE="normal" />

  <script language="javascript">
    function isValidIP(ip) {
      return /^(\d{1,3}\.){3}\d{1,3}$/.test(ip);
    }

    function sanitizeInput(str) {
      return str.replace(/["';]/g, '');
    }

    function runPowerShell(command, outputElementId) {
      try {
        var shell = new ActiveXObject("WScript.Shell");
        var escapedCommand = command.replace(/"/g, '\\"');
        var fullCommand = 'powershell.exe -NoProfile -ExecutionPolicy Bypass -Command "' + escapedCommand + '"';
        var exec = shell.Exec(fullCommand);
        var output = "";
        while (!exec.StdOut.AtEndOfStream) {
          output += exec.StdOut.ReadLine() + "\n";
        }

        if (outputElementId) {
          var outputElement = document.getElementById(outputElementId);
          if (outputElement) {
            outputElement.value = output;
          } else {
            alert("Output element '" + outputElementId + "' not found.");
          }
        }
      } catch (e) {
        if (outputElementId) {
          var outputElement = document.getElementById(outputElementId);
          if (outputElement) {
            outputElement.value = "Error: " + e.message;
          } else {
            alert("Output element '" + outputElementId + "' not found. Error: " + e.message);
          }
        } else {
          alert("PowerShell error: " + e.message);
        }
      }
    }

    function getPrinterPorts() {
      var server = sanitizeInput(document.getElementById("portServer").value);
      if (!server) {
        alert("Please enter a valid server name.");
        return;
      }
      var cmd = "Get-PrinterPort -ComputerName '" + server + "' | Select-Object Name, HostAddress | Format-Table -AutoSize";
      runPowerShell(cmd, "outputPorts");
    }

    function pingIP() {
      var ip = sanitizeInput(document.getElementById("pingIP").value);
      if (!isValidIP(ip)) {
        alert("Invalid IP address format.");
        return;
      }
      var cmd = "ping " + ip;
      runPowerShell(cmd, "outputPing");
    }

    function listDrivers() {
      var server = sanitizeInput(document.getElementById("driverServer").value);
      if (!server) {
        alert("Please enter a valid server name.");
        return;
      }
      var cmd = "Get-PrinterDriver -ComputerName '" + server + "' | Select-Object Name, Manufacturer | Format-Table -AutoSize";
      runPowerShell(cmd, "outputDrivers");
    }

    function installPrinter() {
      var server = sanitizeInput(document.getElementById("installServer").value);
      var portIP = sanitizeInput(document.getElementById("installPort").value);
      var printerName = sanitizeInput(document.getElementById("installShare").value);
      var driverName = sanitizeInput(document.getElementById("printerDriver").value);

      if (!server || !portIP || !printerName || !driverName) {
        alert("All fields must be filled out.");
        return;
      }

      if (!isValidIP(portIP)) {
        alert("Invalid IP address format.");
        return;
      }

      var cmd = '$portName = "IP_" + "' + portIP + '"; ';
      cmd += 'if (-not (Get-PrinterPort -ComputerName \'' + server + '\' -Name $portName -ErrorAction SilentlyContinue)) { ';
      cmd += 'Add-PrinterPort -ComputerName \'' + server + '\' -Name $portName -PrinterHostAddress "' + portIP + '"; ';
      cmd += '} ';
      cmd += 'Add-Printer -ComputerName \'' + server + '\' -Name "' + printerName + '" -PortName $portName -DriverName "' + driverName + '"';

      runPowerShell(cmd); // No output element passed
      alert("Printer installation command sent.");
    }

    function listPrinters() {
      var server = sanitizeInput(document.getElementById("printerListServer").value);
      if (!server) {
        alert("Please enter a valid server name.");
        return;
      }
      var cmd = "Get-Printer -ComputerName '" + server + "' | Select-Object Name, ShareName, DriverName | Format-Table -AutoSize";
      runPowerShell(cmd, "outputPrinterList");
    }
  </script>
</head>

<body bgcolor="lightblue" style="font-family:Segoe UI; padding:10px;">
  <h2>Windows Print Server Network Printer Installation Tool</h2>

  <h3>Get Printer Ports</h3>
  <label>Server:</label> <input type="text" id="portServer" />
  <button onclick="getPrinterPorts()">Get Ports</button><br/>
  <textarea id="outputPorts" rows="6" cols="80"></textarea>

  <h3>Ping IP Address</h3>
  <label>IP Address:</label> <input type="text" id="pingIP" />
  <button onclick="pingIP()">Ping</button><br/>
  <textarea id="outputPing" rows="6" cols="80"></textarea>

  <h3>List Installed Print Drivers</h3>
  <label>Server:</label> <input type="text" id="driverServer" />
  <button onclick="listDrivers()">List Drivers</button><br/>
  <textarea id="outputDrivers" rows="6" cols="80"></textarea>

  <h3>Install Printer on Server</h3>
  <label>Server:</label> <input type="text" id="installServer" /><br/>
  <label>Port (IP):</label> <input type="text" id="installPort" /><br/>
  <label>Printer Share Name:</label> <input type="text" id="installShare" /><br/>
  <label>Printer Driver Name:</label> <input type="text" id="printerDriver" placeholder="e.g., HP Universal Printing PCL 6" /><br/>
  <button onclick="installPrinter()">Install Printer on Server</button><br/>

  <h3>List Printers on Server</h3>
  <label>Server:</label> <input type="text" id="printerListServer" />
  <button onclick="listPrinters()">List Printers</button><br/>
  <textarea id="outputPrinterList" rows="8" cols="125"></textarea>
</body>
</html>

